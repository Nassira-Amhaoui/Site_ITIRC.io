<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard √âtudiant - ITIRC</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="c.css" />

</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <img src="Media/profile.png" alt="Etudiant" id="sidebarPhoto" />
    <h3 id="sidebarName">Nom Pr√©nom</h3>
    <p id="sidebarEmail">email@example.com</p>
  </div>
  <nav>
    <a href="#" class="nav-link active" data-section="accueil">
      <span class="nav-icon"><i class="fas fa-house"></i></span><span class="text">Accueil</span>
    </a>
    <a href="#" class="nav-link" data-section="profil">
      <span class="nav-icon"><i class="fas fa-user"></i></span><span class="text">Mon Profil</span>
    </a>
    <a href="#" id="logout-btn" class="nav-link">
      <span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span>
      <span class="text">D√©connexion</span>
    </a>
  </nav>
  <div class="toggle-btn" id="toggleSidebar" title="R√©duire/√âtendre le menu">‚ùÆ</div>
</aside>

<main class="main">
  <section id="accueil" class="content-section active">
    <h2>Mes Modules</h2>
    <div id="modulesContainer"></div>
  </section>

 <section id="profil" class="content-section">
  <h2>Mon Profil</h2>
  <div class="form-group">
    <label>Photo de profil</label>
    <div class="photo-preview">
      <img src="https://via.placeholder.com/100" alt="Photo actuelle" id="profilePreview">
      <input type="file" id="profileUpload" accept="image/*">
    </div>
  </div>
  <div class="form-group">
    <label>Pr√©nom</label>
    <input type="text" id="firstName">
  </div>
  <div class="form-group">
    <label>Nom</label>
    <input type="text" id="lastName">
  </div>
  <div class="form-group">
    <label>Email acad√©mique</label>
    <input type="email" id="profileEmail" readonly>
  </div>
  <div>
    <button onclick="togglePasswordForm()" class="btn-secondary">Modifier le mot de passe</button>
  </div>
  <div id="passwordForm" class="hidden password-form">
    <h3>Changer le mot de passe</h3>
    <input type="password" placeholder="Ancien mot de passe" />
    <input type="password" placeholder="Nouveau mot de passe" />
    <input type="password" placeholder="Confirmer le mot de passe" />
    <button class="btn">Valider</button>
  </div>
  <div class="form-actions">
    <button type="submit" class="btn" id="saveProfile">Enregistrer</button>
  </div>
</section>


</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

// --- Config Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyCunanBURdN_5MaEKxBNN3DfY8WfQsZZIM",
  authDomain: "itirc-platforme.firebaseapp.com",
  projectId: "itirc-platforme",
  storageBucket: "itirc-platforme.appspot.com",
  messagingSenderId: "889482668204",
  appId: "1:889482668204:web:148553ea7d4d5784ca9709",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// --- Elements DOM ---
const firstNameInput = document.getElementById("firstName");
const lastNameInput = document.getElementById("lastName");
const profileEmailInput = document.getElementById("profileEmail");
const profilePreviewImg = document.getElementById("profilePreview");
const profileUploadInput = document.getElementById("profileUpload");
const saveProfileBtn = document.getElementById("saveProfile");
const passwordForm = document.getElementById("passwordForm");
const passwordBtn = passwordForm.querySelector("button");

// -------------------------
// Trouver le document √©tudiant dans S1, S2, S3
// -------------------------
async function findStudentDoc(uid) {
  const semesters = ["S1", "S2", "S3"];
  for (let semester of semesters) {
    const docRef = doc(db, "users", "rolesDoc", "etudiants", "semestres", semester, uid);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      return { ref: docRef, data: docSnap.data() };
    }
  }
  return null;
}

// -------------------------
// Charger profil actuel
// -------------------------
async function loadProfile() {
  const uid = localStorage.getItem("uid");
  if (!uid) return alert("‚ùå UID non trouv√© dans localStorage");

  const student = await findStudentDoc(uid);
  if (!student) return alert("‚ö†Ô∏è Document √©tudiant introuvable !");

  firstNameInput.value = student.data.firstName || "";
  lastNameInput.value = student.data.lastName || "";
  profileEmailInput.value = student.data.email || "";
  if (student.data.photoURL) {
    profilePreviewImg.src = student.data.photoURL;
    document.getElementById("sidebarPhoto").src = student.data.photoURL;
  }
}

// -------------------------
// Enregistrer pr√©nom/nom
// -------------------------
saveProfileBtn.addEventListener("click", async () => {
  const uid = localStorage.getItem("uid");
  if (!uid) return alert("‚ùå UID non trouv√©");

  const firstName = firstNameInput.value.trim();
  const lastName = lastNameInput.value.trim();
  if (!firstName || !lastName) return alert("Veuillez remplir pr√©nom et nom");

  const student = await findStudentDoc(uid);
  if (!student) return alert("‚ö†Ô∏è Document √©tudiant introuvable !");

  try {
    await updateDoc(student.ref, {
      firstName,
      lastName,
      nom: `${firstName} ${lastName}`,
    });
    document.getElementById("sidebarName").textContent = `${firstName} ${lastName}`;
    alert("‚úÖ Profil mis √† jour avec succ√®s !");
  } catch (err) {
    console.error(err);
    alert("‚ùå Erreur mise √† jour profil : " + err.message);
  }
});

// -------------------------
// Upload photo de profil
// -------------------------
profileUploadInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const uid = localStorage.getItem("uid");
  if (!uid) return alert("‚ùå UID non trouv√©");

  try {
    const storageRef = ref(storage, `photos_etudiants/${uid}.jpg`);
    await uploadBytes(storageRef, file);
    const photoURL = await getDownloadURL(storageRef);

    profilePreviewImg.src = photoURL;
    document.getElementById("sidebarPhoto").src = photoURL;

    const student = await findStudentDoc(uid);
    if (student) await updateDoc(student.ref, { photoURL });

    alert("‚úÖ Photo de profil mise √† jour !");
  } catch (err) {
    console.error(err);
    alert("‚ùå Erreur upload photo : " + err.message);
  }
});

// -------------------------
// Toggle mot de passe
// -------------------------
window.togglePasswordForm = () => passwordForm.classList.toggle("hidden");

// -------------------------
// Modifier le mot de passe
// -------------------------
passwordBtn.addEventListener("click", async () => {
  const oldPass = passwordForm.querySelector("input:nth-child(2)").value;
  const newPass = passwordForm.querySelector("input:nth-child(3)").value;
  const confirmPass = passwordForm.querySelector("input:nth-child(4)").value;

  if (newPass !== confirmPass) {
    return alert("‚ùå Les mots de passe ne correspondent pas !");
  }

  const user = auth.currentUser;
  if (!user) return alert("‚ùå Utilisateur non authentifi√©");

  try {
    const credential = EmailAuthProvider.credential(user.email, oldPass);
    await reauthenticateWithCredential(user, credential);
    await updatePassword(user, newPass);
    alert("‚úÖ Mot de passe mis √† jour !");
    passwordForm.classList.add("hidden");
  } catch (err) {
    console.error(err);

    // --- Personnalisation du message ---
    let msg = "‚ùå Erreur lors de la mise √† jour du mot de passe.";
    if (err.code === "auth/invalid-login-credentials" || err.code === "auth/wrong-password") {
      msg = "‚ùå Ancien mot de passe incorrect. Veuillez r√©essayer.";
    } else if (err.code === "auth/weak-password") {
      msg = "‚ùå Le nouveau mot de passe est trop faible (minimum 6 caract√®res).";
    }

    alert(msg);
  }
});


// -------------------------
// Charger le profil au d√©marrage
// -------------------------
onAuthStateChanged(auth, (user) => {
  if (!user) return alert("Utilisateur non authentifi√©");
  loadProfile();
});

</script>

<script>
const API_BASE = ""; // m√™me origine, sinon "http://localhost:5000"
let modulesEtudiants = [];

function getUserFromStorage() {
  try {
    const raw = sessionStorage.getItem('user') || localStorage.getItem('user');
    return raw ? JSON.parse(raw) : {};
  } catch (_) { return {}; }
}

async function chargerEtudiantEtModules() {
  try {
    const user = getUserFromStorage();
    const uid = user?.uid || localStorage.getItem('uid');
    const semestreLogin = user?.semester || user?.semestre;
    if (!uid) throw new Error("UID manquant");

    const etuRes = await fetch(`${API_BASE}/api/etudiant/${uid}`);
    const etudiant = await etuRes.json();

    // --- Mettre √† jour sidebar et profil ---
    document.getElementById("sidebarName").textContent = etudiant.nom || "Nom inconnu";
    document.getElementById("sidebarEmail").textContent = etudiant.email || "email inconnu";
    document.getElementById("sidebarPhoto").src = etudiant.photoURL || "Media/profile.png";
    document.getElementById("profileName")?.setAttribute("readonly", true);
    document.getElementById("profileEmail").value = etudiant.email || "";
    document.getElementById("firstName").value = etudiant.firstName || "";
    document.getElementById("lastName").value = etudiant.lastName || "";
    if (etuRes.photoURL) document.getElementById("profilePreview").src = etudiant.photoURL;

    // --- Charger les modules ---
    const semestre = semestreLogin || etudiant.semestre;
    const modRes = await fetch(`${API_BASE}/api/modules/${semestre}`);
    modulesEtudiants = await modRes.json();
    await renderModulesAvecRessources();
  } catch (err) {
    console.error('[Front Etu] Chargement KO:', err);
    alert("Erreur lors du chargement des donn√©es. D√©tails en console.");
  }
}

async function renderModulesAvecRessources() {
  const container = document.getElementById("modulesContainer");
  container.innerHTML = "";

  if (!modulesEtudiants || modulesEtudiants.length === 0) {
    container.innerHTML = `<p>Aucun module trouv√©.</p>`;
    return;
  }

  for (const mod of modulesEtudiants) {
    const moduleDiv = document.createElement("div");
    moduleDiv.classList.add("semester-block");

    const circle = document.createElement("div");
    circle.classList.add("semester-circle");
    circle.textContent = `M${mod.ordre ?? "?"}`;

    const moduleInfo = document.createElement("div");
    moduleInfo.classList.add("module-info");

    const moduleNameDiv = document.createElement("div");
    moduleNameDiv.classList.add("module-name");
    moduleNameDiv.innerHTML = `<span class="module-icon">üìò</span> <span>${mod.name || "Sans nom"}</span>`;

    moduleInfo.appendChild(moduleNameDiv);
    moduleDiv.appendChild(circle);
    moduleDiv.appendChild(moduleInfo);
    container.appendChild(moduleDiv);

    const resRes = await fetch(`${API_BASE}/api/modules/${mod.id}/ressources`);
    const data = await resRes.json();
    if (!data.ressources || !data.ressources.length) continue;

    let coursHTML = '', tdHTML = '', tpHTML = '';
    data.ressources.forEach(r => {
      const lien = `<li><strong>${r.nom}</strong> - <a href="${r.fichierUrl}" target="_blank">T√©l√©charger</a></li>`;
      if (r.type === 'cours') coursHTML += lien;
      else if (r.type === 'td') tdHTML += lien;
      else if (r.type === 'tp') tpHTML += lien;
    });

    if (coursHTML) {
      const div = document.createElement('div');
      div.className = 'resource-card cours';
      div.innerHTML = `<h4>Cours</h4><ul>${coursHTML}</ul>`;
      moduleDiv.appendChild(div);
    }
    if (tdHTML) {
      const div = document.createElement('div');
      div.className = 'resource-card td';
      div.innerHTML = `<h4>TD</h4><ul>${tdHTML}</ul>`;
      moduleDiv.appendChild(div);
    }
    if (tpHTML) {
      const div = document.createElement('div');
      div.className = 'resource-card tp';
      div.innerHTML = `<h4>TP</h4><ul>${tpHTML}</ul>`;
      moduleDiv.appendChild(div);
    }
  }
}

// --- Sidebar & navigation ---
document.getElementById('logout-btn')?.addEventListener('click', () => {
  localStorage.clear();
  sessionStorage.clear();
  window.location.href = '/authentification.html';
});

document.getElementById("toggleSidebar").addEventListener("click", () => {
  document.getElementById("sidebar").classList.toggle("collapsed");
});

function togglePasswordForm() {
  document.getElementById("passwordForm").classList.toggle("hidden");
}
window.togglePasswordForm = togglePasswordForm;

document.querySelectorAll(".nav-link").forEach(link => {
  link.addEventListener("click", e => {
    e.preventDefault();
    const targetId = link.dataset.section;
    document.querySelectorAll(".nav-link").forEach(l => l.classList.remove("active"));
    link.classList.add("active");
    document.querySelectorAll(".content-section").forEach(section => {
      section.classList.toggle("active", section.id === targetId);
    });
  });
});

document.getElementById("profileUpload").addEventListener("change", function (e) {
  const reader = new FileReader();
  reader.onload = (ev) => { document.getElementById("profilePreview").src = ev.target.result; };
  if (e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
});

chargerEtudiantEtModules();
</script>


</body>
</html>
